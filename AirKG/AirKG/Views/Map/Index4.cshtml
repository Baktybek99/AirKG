@using AirKG.ViewModels.Markers;
@model MapModel

<div style="position: relative;">
    @foreach (var index in Model.Sensors)
    {
        <button data-bs-toggle="modal" data-bs-target="#staticBackdrop" data-action=@index.Id class="map-marker" href="#" style="position: absolute; z-index:100; left: @HTMLstatic.GetCore(index.Latitude)px; top: @HTMLstatic.GetCore(index.Longitude)px;">
            <span class="tooltiptext">Чистота @index.AirQuality , @index.PlaceName</span>
        </button>
    }
    <div class="image-container">
        <img src="~/Files/Untitled.png" alt="Первое изображение" class="bottom-image">
        <svg class="b-map-svg" version="1.0" xmlns="http://www.w3.org/2000/svg"
             width="350mm" height="350mm" viewBox="0 0 300.000000 1000.000000"
             preserveAspectRatio="xMidYMid meet">


            <a href="~/Map/Index4">
                <g class="area4 example" transform="translate(0.000000,743) scale(0.100000,-0.100000)" stroke="red" stroke-width="20"
                   fill="gray">
                    <path d="M2808 4153 c-27 -4 -28 -6 -44 -95 -3 -21 -9 -38 -13 -38 -4 0 -47 9
                            -97 20 l-89 20 -65 -44 -65 -44 -280 -46 c-187 -30 -326 -47 -420 -51 -77 -3
                            -225 -10 -330 -16 -104 -5 -203 -11 -220 -11 -16 -1 -56 2 -88 6 l-58 8 5 -58
                            c3 -33 8 -110 11 -171 6 -107 5 -113 -13 -113 -23 0 -32 18 -32 68 0 73 -4 77
                            -70 74 -44 -3 -59 -8 -62 -20 -8 -29 2 -42 32 -42 24 0 28 -5 34 -37 12 -75 8
                            -77 -46 -13 -46 56 -54 61 -82 56 -70 -12 -327 -39 -331 -34 -3 2 -8 32 -11
                            66 -7 61 -7 62 -41 68 -27 5 -39 2 -56 -14 -19 -18 -30 -20 -80 -15 -32 3 -60
                            10 -63 14 -3 5 -16 9 -30 9 -25 0 -25 -1 -17 -57 4 -32 8 -130 7 -218 0 -138
                            -7 -211 -53 -530 -29 -203 -55 -394 -58 -424 -6 -54 -6 -54 18 -46 27 8 240
                            36 251 32 3 -1 48 -54 98 -117 l92 -115 91 -5 91 -5 12 -48 c7 -27 14 -50 16
                            -52 2 -2 93 14 203 37 l199 40 146 131 c162 146 156 136 159 292 1 69 5 76 51
                            110 26 19 46 25 87 25 l53 0 0 -63 0 -62 115 4 115 3 1 -28 c1 -16 1 -94 0
                            -174 l-2 -145 -35 -31 -34 -31 10 -54 c23 -116 36 -124 209 -132 68 -3 126 -8
                            128 -11 3 -2 11 -34 20 -70 10 -45 19 -66 29 -66 8 0 41 -18 74 -40 63 -43 77
                            -70 65 -132 l-7 -34 90 4 89 4 22 -30 c11 -17 24 -51 27 -76 5 -36 11 -46 26
                            -46 23 0 38 -37 38 -93 0 -50 2 -52 63 -101 42 -34 47 -43 47 -78 0 -27 10
                            -59 30 -93 35 -60 47 -65 172 -65 72 0 79 2 73 18 -9 22 -24 189 -25 268 0 59
                            2 63 40 97 25 23 60 42 97 52 32 9 87 25 123 35 36 11 83 21 105 24 92 11 146
                            23 157 34 9 9 15 5 24 -18 12 -28 17 -30 64 -30 28 0 60 5 71 10 22 12 141 0
                            296 -31 86 -17 108 -18 143 -8 22 7 40 15 39 18 0 3 -24 26 -52 51 l-52 45
                            -90 -6 c-73 -5 -100 -2 -144 13 -30 10 -62 18 -73 18 -10 0 -42 14 -71 30 -30
                            17 -65 30 -79 30 -15 0 -98 -11 -185 -25 -198 -31 -193 -31 -193 1 0 29 -16
                            48 -47 58 -18 6 -26 -1 -48 -43 -30 -54 -39 -60 -102 -71 l-43 -7 0 51 c0 28
                            5 105 11 171 6 66 10 154 9 195 -1 41 4 206 9 365 6 160 20 576 31 925 11 349
                            22 668 24 708 l4 72 -111 -1 c-62 -1 -124 -4 -139 -6z" />
                </g>
            </a>
        </svg>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ...
                <div id="ChartView">
                    <canvas id="myChart"></canvas>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Understood</button>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

@section scripts
    {
    <script type="text/javascript">
        $(document).ready(function () {
            function OnError(err) {

            }

            $('.map-marker').click(function () {

                var chartView = document.getElementById('ChartView');

                chartView.innerHTML = '&nbsp;';
                var sensorId = $(this).data('action');
                console.log(sensorId);
                $("#ChartView").append('<canvas id="myChart" style="max-height:500px;max-width:1000px"></canvas>')
                $.ajax({
                    type: "GET",
                    url: `/Chart/GetResult?sensorId=${sensorId}`,
                    data: "",
                    contentType: "application/json: charset=utf-8",
                    dataType: "json",
                    success: OnSuccesResult,
                    error: OnError
                })

                function OnSuccesResult(data) {
                    var _data = data;
                    var _chartLabels = _data[0];
                    var _chartData = _data[1];

                    new Chart("myChart", {
                        type: 'bar',
                        data: {
                            labels: _chartLabels,
                            datasets: [{
                                label: 'My Dataset',
                                data: _chartData,
                                backgroundColor: function (context) {
                                    var value = context.dataset.data[context.dataIndex];
                                    if (value <= 15) {
                                        return 'Blue';
                                    } else if (value >= 16 && value <= 35) {
                                        return 'Green';
                                    } else if (value >= 36 && value <= 75) {
                                        return 'Yellow';
                                    } else if (value >= 76 && value <= 100) {
                                        return 'Red';
                                    } else {
                                        return 'Black'
                                    }
                                }
                            }]
                        }
                    });

                    console.log("Finish All");
                }
            })

        })
    </script>
}

